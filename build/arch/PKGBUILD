# Maintainer: Helper Node Team <support@helper-node.app>
pkgname=helper-node
pkgver=0.0.1
pkgrel=1
pkgdesc="AI-powered voice assistant with Whisper transcription"
arch=('x86_64')
url="https://github.com/SoderJuliano/helper-node"
license=('MIT')
depends=('curl' 'ffmpeg' 'nodejs' 'gtk3' 'libnotify' 'nss' 'libxss' 'libxtst' 'xdg-utils' 'at-spi2-core' 'alsa-lib')
optdepends=(
    'gnome-shell: For GNOME desktop integration'
    'plasma-workspace: For KDE Plasma integration'  
    'hyprland: For Hyprland window manager integration'
)
source=("${pkgname}-${pkgver}.tar.gz")
sha256sums=('SKIP')

build() {
    cd "${srcdir}/helper-node"
    
    # Install all dependencies including electron
    npm install --production
    npm install electron --save-dev
    
    echo "Project is ready to use"
}

package() {
    cd "${srcdir}/helper-node"
    
    # Create installation directory
    install -dm755 "${pkgdir}/opt/helper-node"
    
    # Copy all project files
    cp -r * "${pkgdir}/opt/helper-node/"
    
    # Remove unnecessary files
    rm -rf "${pkgdir}/opt/helper-node/build"
    rm -rf "${pkgdir}/opt/helper-node/dist" 
    rm -rf "${pkgdir}/opt/helper-node/.git" 2>/dev/null || true
    
    # Set executable permissions
    chmod +x "${pkgdir}/opt/helper-node/helper-node.sh"
    chmod +x "${pkgdir}/opt/helper-node/setup-hotkey.sh"
    chmod +x "${pkgdir}/opt/helper-node/whisper/build/bin"/* 2>/dev/null || true
    
    # Install desktop entry
    install -Dm644 helper-node.desktop "${pkgdir}/usr/share/applications/helper-node.desktop"
    
    # Install icon (if exists)
    if [ -f "assets/linux.png" ]; then
        install -Dm644 assets/linux.png "${pkgdir}/usr/share/pixmaps/helper-node.png"
    fi
    
    # Create symlink
    install -dm755 "${pkgdir}/usr/local/bin"
    ln -s /opt/helper-node/helper-node.sh "${pkgdir}/usr/local/bin/helper-node"
}

post_install() {
    echo ""
    echo "==> Helper Node installed successfully!"
    echo "==> To start Helper Node, run: helper-node"
    echo "==> Or find it in your applications menu."
    echo ""
    echo "==> Global hotkeys will be configured on first run."
    echo "==> The setup-hotkey.sh script will run automatically when you first start the application."
    echo "==> Supported environments: GNOME, KDE Plasma, Hyprland"
    echo ""
    echo "==> For manual hotkey setup, run: /opt/helper-node/setup-hotkey.sh"
    echo ""
}

post_upgrade() {
    post_install
}

pre_remove() {
    # Cleanup if needed
    rm -f /usr/local/bin/helper-node 2>/dev/null || true
}
